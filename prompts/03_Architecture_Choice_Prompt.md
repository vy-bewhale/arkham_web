# Промт 03: Выбор Архитектуры для Arkham Client Streamlit App

**Роль:** Системный Архитектор

**Дата:** {{YYYY-MM-DD}} <!-- Замени на текущую дату -->

**Контекст:** Мы разрабатываем интерактивное веб-приложение Streamlit на основе библиотеки `arkham_client`. Пользовательский интерфейс спроектирован (см. `streamlit_app/docs/UI_Specification.md`). Теперь необходимо определить простую, но надежную, эффективную и расширяемую архитектуру для приложения.

**Цель:** Выбрать и описать архитектуру приложения, которая обеспечит:
*   Четкое разделение ответственности (по возможности).
*   Эффективное управление состоянием приложения.
*   Удобное взаимодействие с библиотекой `arkham_client`.
*   Легкость поддержки и будущего расширения функционала.
*   Оптимальное использование ресурсов и производительность.

**Ключевые Аспекты Архитектуры для Рассмотрения:**

1.  **Структура Кода и Файлов:**
    *   Как будет организован код? Один большой файл `app.py` или несколько модулей?
2.  **Управление Состоянием (`Session State`):**
    *   Какие данные необходимо хранить в `st.session_state`? (например, загруженный API-ключ, инстанс `ArkhamMonitor`, DataFrame с результатами, состояние кеша `arkham_client`, выбранные значения фильтров).
    *   Как инициализировать и обновлять состояние?
3.  **Взаимодействие с `arkham_client`:**
    *   Где и как будет инициализироваться экземпляр `ArkhamMonitor`?
    *   Как будут вызываться его методы (`set_filters`, `get_transactions`, `get_known_address_names`, etc.)?
    *   Как обрабатывать возможные исключения от библиотеки?
4.  **Кеширование на Уровне Streamlit:**
    *   Целесообразно ли использовать `@st.cache_data` или `@st.cache_resource` для функций, взаимодействующих с `arkham_client` или для самого объекта `ArkhamMonitor`?
5.  **Обработка Пользовательского Ввода и Логика UI:**
    *   Где будет располагаться логика, связанная с обработкой нажатий кнопок, изменением фильтров?
6.  **Загрузка Конфигурации (API-ключ):**
    *   Механизм безопасной загрузки API-ключа (через `python-dotenv` из `.env` файла).

**Варианты Архитектуры:**

*   **Вариант 1: Монолитный `app.py`**
    *   **Описание:** Весь код приложения (UI, логика, взаимодействие с `arkham_client`) находится в одном файле `app.py`.
    *   **Управление состоянием:** Активное использование `st.session_state` для всех переменных, которые должны сохраняться между взаимодействиями.
    *   **Плюсы:** Простота для небольших приложений, легко начать.
    *   **Минусы:** Может быстро стать сложным для чтения и поддержки при росте функционала. Слабое разделение ответственности.
    *   *Оценка:* Простота реализации (9/10), Надежность (7/10), Эффективность (7/10), Расширяемость (5/10), Поддерживаемость (6/10).

*   **Вариант 2: `app.py` + Модуль для Логики `arkham_client`**
    *   **Описание:**
        *   `app.py`: Основной файл Streamlit, отвечает за отрисовку UI и обработку событий.
        *   `arkham_logic.py` (или `arkham_service.py`): Модуль, инкапсулирующий всю логику взаимодействия с `arkham_client` (инициализация, вызов методов, обработка данных и ошибок). `app.py` вызывает функции из этого модуля.
    *   **Управление состоянием:** `st.session_state` используется в `app.py` для хранения данных UI и результатов, полученных от `arkham_logic.py`.
    *   **Плюсы:** Лучшее разделение ответственности. `app.py` остается чище. Логику `arkham_client` легче тестировать отдельно (в теории).
    *   **Минусы:** Небольшое усложнение структуры проекта.
    *   *Оценка:* Простота реализации (7/10), Надежность (8/10), Эффективность (8/10), Расширяемость (8/10), Поддерживаемость (8/10).

*   **Вариант 3: `app.py` + Модуль Логики + Модуль UI Компонентов**
    *   **Описание:**
        *   `app.py`: Точка входа, управление общей структурой и состоянием.
        *   `arkham_logic.py`: Как в Варианте 2.
        *   `ui_components.py`: Модуль, содержащий функции для отрисовки отдельных частей UI (например, `render_sidebar(session_state)`, `render_results_table(dataframe)`). `app.py` вызывает эти функции.
    *   **Управление состоянием:** `st.session_state` передается в функции UI компонентов или используется ими напрямую.
    *   **Плюсы:** Максимальное разделение ответственности. Очень хорошая расширяемость и поддерживаемость. `app.py` становится очень компактным.
    *   **Минусы:** Наибольшее усложнение структуры для текущего, вероятно, не очень большого объема кода. Может быть избыточным.
    *   *Оценка:* Простота реализации (5/10), Надежность (9/10), Эффективность (8/10), Расширяемость (9/10), Поддерживаемость (9/10).

**Процесс Выбора и Обоснования:**

1.  **Оценить каждый вариант** по предложенным критериям (Простота реализации, Надежность, Эффективность, Расширяемость, Поддерживаемость) по 10-балльной шкале.
2.  **Выбрать наиболее подходящий вариант**, учитывая текущий предполагаемый размер приложения и требования к простоте и расширяемости.
3.  **Детально обосновать выбор**, указав, почему выбранный вариант лучше других для данного проекта.
4.  **Провести самокритику выбранной архитектуры:**
    *   Какие потенциальные проблемы или узкие места могут возникнуть?
    *   Что не учтено или чрезмерно упрощено?
    *   Как можно смягчить эти проблемы или улучшить архитектуру без значительного усложнения?
5.  **Описать Ключевые Решения в рамках выбранной архитектуры:**
    *   Как будет инициализироваться и храниться `ArkhamMonitor` (например, в `st.session_state` с использованием `@st.cache_resource` для его создания).
    *   Как будут кешироваться данные, полученные от `arkham_client` (например, списки токенов/адресов с помощью `@st.cache_data` или через `st.session_state` после загрузки).
    *   Структура `st.session_state` (какие ключи будут использоваться).

**Результат:**

*   Четкое описание выбранной архитектуры приложения.
*   Обоснование выбора.
*   Анализ потенциальных проблем и пути их решения.
*   Схема управления состоянием и взаимодействия компонентов.
*   Этот документ будет служить основой для файла `streamlit_app/docs/Architecture_Specification.md` и для разработки детального плана кодирования. 