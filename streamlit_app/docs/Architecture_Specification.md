# Спецификация Архитектуры Приложения Arkham Client Streamlit App

**Дата:** {{YYYY-MM-DD}} <!-- Замени на текущую дату -->
**Версия:** 1.0

**1. Обзор**

Этот документ описывает выбранную архитектуру для веб-приложения Streamlit, предназначенного для взаимодействия с библиотекой `arkham_client`. Цель — обеспечить простоту, надежность, эффективность и расширяемость.

**2. Выбранная Архитектура: Вариант 2 (`app.py` + Модуль Сервиса)**

Выбрана архитектура, состоящая из основного файла приложения `app.py` и отдельного модуля `arkham_service.py`, который инкапсулирует всю логику взаимодействия с библиотекой `arkham_client`.

*   **`app.py`**: Отвечает за отрисовку пользовательского интерфейса (согласно `UI_Specification.md`), обработку пользовательских событий (нажатия кнопок, изменения фильтров) и управление состоянием приложения через `st.session_state`.
*   **`arkham_service.py`**: Предоставляет функции для работы с `arkham_client`: инициализация клиента, применение фильтров, выполнение запросов транзакций, получение данных для кеша (списки адресов, токенов), обработка данных от `arkham_client` и базовая обработка ошибок.

**Обоснование выбора:**
*   **Баланс:** Оптимальный компромисс между простотой и структурированностью для приложения данного масштаба.
*   **Разделение Ответственности:** Четкое разделение между логикой представления (`app.py`) и бизнес-логикой/взаимодействием с внешним сервисом (`arkham_service.py`).
*   **Поддерживаемость и Расширяемость:** Упрощает поддержку и будущее развитие. Изменения в логике `arkham_client` изолированы в `arkham_service.py`.

**3. Структура Проекта (внутри `streamlit_app/`)**

```
streamlit_app/
├── app.py                     # Основной файл приложения Streamlit
├── arkham_service.py          # Модуль для логики работы с arkham_client
├── requirements.txt           # Зависимости приложения
├── assets/                    # Опциональная директория для статических файлов (например, CSS)
│   └── style.css              # Пользовательские стили
└── docs/
    ├── UI_Specification.md
    └── Architecture_Specification.md # Этот документ
```
*Примечание: Файл `.env` с API-ключом должен находиться в корневой директории проекта (`arkham_web/`), на один уровень выше `streamlit_app/`.*

**4. Управление Состоянием (`st.session_state`)**

`st.session_state` будет активно использоваться в `app.py` для хранения данных, необходимых между перерисовками интерфейса. Ключевые элементы состояния:

*   `st.session_state.api_key`: (str) Загруженный API-ключ Arkham.
*   `st.session_state.api_key_loaded`: (bool) Флаг успешной загрузки API-ключа.
*   `st.session_state.arkham_monitor`: (ArkhamMonitor) Экземпляр клиента `ArkhamMonitor`. Инициализируется один раз.
*   `st.session_state.cache_initialized_flag`: (bool) Флаг, указывающий, что первоначальное наполнение кеша `arkham_client` было выполнено.
*   `st.session_state.known_tokens`: (list) Список известных символов токенов, полученный из кеша `arkham_client`.
*   `st.session_state.known_addresses`: (list) Список известных имен/адресов, полученный из кеша `arkham_client`.
*   `st.session_state.transactions_df`: (pd.DataFrame) DataFrame с результатами последнего запроса транзакций.
*   `st.session_state.error_message`: (str | None) Сообщение об ошибке для отображения пользователю.
*   Значения для каждого фильтра UI (например, `st.session_state.min_usd_filter_value`) будут также неявно храниться Streamlit, если для виджетов указан параметр `key`.

Инициализация `st.session_state` будет происходить в начале `app.py`.

**5. Взаимодействие с `arkham_client` (через `arkham_service.py`)**

*   **Инициализация `ArkhamMonitor`:**
    *   API-ключ загружается в `app.py` из `.env` при старте.
    *   В `app.py`, при первой инициализации `st.session_state` (или если `arkham_monitor` еще не создан), будет вызвана функция из `arkham_service.py` (например, `arkham_service.create_monitor(api_key)`), которая вернет экземпляр `ArkhamMonitor`. Этот экземпляр будет сохранен в `st.session_state.arkham_monitor`.
    *   Использование `@st.cache_resource` для функции `create_monitor` не предполагается, так как экземпляр будет жить в `st.session_state` на протяжении сессии.
*   **Вызов Методов:**
    *   `app.py` будет вызывать функции из `arkham_service.py` для выполнения всех операций с `arkham_client` (например, `arkham_service.populate_arkham_cache(st.session_state.arkham_monitor, params)`, `arkham_service.fetch_transactions(st.session_state.arkham_monitor, filter_params)`).
    *   `arkham_service.py` будет содержать логику вызова соответствующих методов `ArkhamMonitor`, таких как `set_filters()`, `get_transactions()`, `get_known_address_names()`, `get_known_token_symbols()`.
*   **Обработка Ошибок:**
    *   Функции в `arkham_service.py` будут стараться перехватывать ожидаемые исключения от `arkham_client` (например, `requests.exceptions.RequestException`, специфичные ошибки API если они определены).
    *   В случае ошибки, функции сервиса могут возвращать `None` или специальный объект/флаг, чтобы `app.py` мог соответствующим образом обновить UI (например, показать сообщение через `st.error()`).

**6. Кеширование на Уровне Streamlit**

*   **`@st.cache_resource`**: Не будет использоваться для самого объекта `ArkhamMonitor`, так как он будет храниться и управляться через `st.session_state` на протяжении всей сессии пользователя.
*   **`@st.cache_data`**: Может быть рассмотрено для функций в `arkham_service.py`, которые возвращают относительно статичные данные и вызываются с одними и теми же параметрами (например, если бы существовала функция, получающая некий справочник от Arkham, не зависящий от пользовательских фильтров). Однако, для основных потоков данных (списки токенов/адресов из кеша `arkham_client`, транзакции) данные будут загружаться по действию пользователя и сохраняться в `st.session_state`. Списки токенов/адресов обновляются после каждой операции "Загрузить/Обновить кеш". Транзакции загружаются по каждому запросу с новыми фильтрами.

**7. Загрузка Конфигурации (API-ключ)**

*   В `app.py` будет использована библиотека `python-dotenv` для загрузки `ARKHAM_API_KEY` из файла `.env`.
*   Путь к файлу `.env` будет указан относительно `app.py` (например, `../.env`).
*   Будет предусмотрена проверка наличия ключа, и в случае его отсутствия, пользователю будет выведено соответствующее сообщение об ошибке.

**8. Потенциальные Проблемы и Улучшения (Самокритика)**

*   **Рост `arkham_service.py`:** Если логика взаимодействия с `arkham_client` значительно усложнится, файл `arkham_service.py` может стать слишком большим. В будущем его можно будет рефакторить на более мелкие модули или классы.
*   **Управление `st.session_state`:** Требуется аккуратность при работе с `st.session_state` в `app.py` для избежания ошибок с состоянием. Четкое именование ключей и проверка их существования перед использованием обязательны.
*   **Тестируемость:** Модульные тесты для `arkham_service.py` будут относительно просты. Тестирование UI-логики в `app.py` останется преимущественно ручным.

Эта архитектура представляет собой сбалансированный подход для текущих требований, обеспечивая хорошую структуру и возможности для будущего развития. 